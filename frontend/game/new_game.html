<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Game - Lost Cities: Le Duel</title>
    <link rel="stylesheet" href="/shared/global.css">
    <style>
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #5b3d2b;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select, input[type="checkbox"] {
            padding: 8px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
        }
        
        .checkbox-container input {
            width: auto;
            margin-right: 10px;
        }
        
        .error-message {
            color: red;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #ffeeee;
            border-radius: 4px;
            display: none;
        }
        
        .success-message {
            color: green;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #eeffee;
            border-radius: 4px;
            display: none;
        }
        
        .button-container {
            text-align: center;
            margin-top: 30px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #5b3d2b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #7a5038;
        }
        
        .game-info {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .game-info h2 {
            margin-top: 0;
            font-size: 18px;
            color: #5b3d2b;
        }

        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #loading-message {
            text-align: center;
            padding: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>New Lost Cities Game</h1>
        
        <div class="game-info">
            <h2>About Lost Cities: Le Duel</h2>
            <p>
                In Lost Cities, you and your opponent engage in expeditions across different terrains.
                Your goal is to score the most points by playing cards in ascending order, placing
                strategic wagers, and managing your resources efficiently.
            </p>
        </div>
        
        <div class="error-message" id="error-message">
            Failed to create game. Please try again.
        </div>

        <div class="success-message" id="success-message">
            Game created successfully! Redirecting to game...
        </div>
        
        <div id="loading-message">Loading available opponents...</div>
        
        <form id="newGameForm" style="display:none;">
            <div class="form-group">
                <label for="opponent_id">Select Opponent</label>
                <select name="opponent_id" id="opponent_id" required>
                    <option value="">Select an opponent</option>
                    <!-- Opponent options will be loaded dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <div class="checkbox-container">
                    <input type="checkbox" name="use_purple" id="use_purple">
                    <label for="use_purple">Include Purple Expedition (Advanced Variant)</label>
                </div>
            </div>
            
            <div class="button-container">
                <button type="submit" id="createGameBtn">Create Game</button>
            </div>
        </form>

        <div class="debug-info" id="debug-info" style="display:none;">
            <h3>Debug Information</h3>
            <p>Current User ID: <span id="current-user-id">Not set</span></p>
            <p>Auth Token Present: <span id="auth-token-status">No</span></p>
            <p>API URL: <span id="api-url">Not set</span></p>
            <button id="create-test-user">Create Test User</button>
        </div>
    </div>

    <script>
        // Check for error parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error') === 'failed') {
            document.getElementById('error-message').style.display = 'block';
        }
        
        // Set up API URL
        const API_URL = window.location.hostname === "localhost"
            ? "http://localhost:3000" // Local backend URL
            : "https://lostcitiesbackend.onrender.com"; // Render backend URL
        
        // Show debug info
        const showDebug = true; // Set to false in production
        if (showDebug) {
            document.getElementById('debug-info').style.display = 'block';
            document.getElementById('current-user-id').textContent = localStorage.getItem('user_id') || 'Not set';
            document.getElementById('auth-token-status').textContent = localStorage.getItem('authToken') ? 'Yes' : 'No';
            document.getElementById('api-url').textContent = API_URL;
        }
        
        // Function to create a test user
        document.getElementById('create-test-user').addEventListener('click', async () => {
            try {
                const username = "player_" + Math.floor(Math.random() * 1000);
                const email = username + "@example.com";
                const password = "password123";
                
                const response = await fetch(`${API_URL}/register`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                if (response.ok) {
                    alert(`Test user created: ${username} / ${password}`);
                } else {
                    const error = await response.json();
                    alert(`Failed to create test user: ${error.error || "Unknown error"}`);
                }
            } catch (error) {
                console.error("Error creating test user:", error);
                alert("Error creating test user. See console for details.");
            }
        });
        
        // Form submission handler
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('newGameForm');
            
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert("Authentication token not found. Please log in again.");
                    window.location.href = '/login.html';
                    return;
                }
                
                // Disable the submit button to prevent double submission
                const submitButton = document.getElementById('createGameBtn');
                submitButton.disabled = true;
                submitButton.textContent = 'Creating Game...';
                
                try {
                    // Get form values
                    const opponentId = document.getElementById('opponent_id').value;
                    const usePurple = document.getElementById('use_purple').checked;
                    
                    console.log("Creating game with:", { opponentId, usePurpleExpedition: usePurple });
                    
                    // Create game via API
                    const response = await fetch(`${API_URL}/lost-cities/games`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            opponentId,
                            usePurpleExpedition: usePurple
                        })
                    });
                    
                    console.log("Game creation response status:", response.status);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Failed to create game");
                    }
                    
                    const responseData = await response.json();
                    console.log("Game created successfully:", responseData);
                    
                    // Show success message
                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('newGameForm').style.display = 'none';
                    
                    // Redirect to the game page
                    setTimeout(() => {
                        window.location.href = `/game/${responseData.gameId}`;
                    }, 1500);
                    
                } catch (error) {
                    console.error("Error creating game:", error);
                    document.getElementById('error-message').textContent = 
                        `Failed to create game: ${error.message}`;
                    document.getElementById('error-message').style.display = 'block';
                    
                    // Re-enable the submit button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Create Game';
                }
            });
        });
        
        // Load available opponents
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    document.getElementById('loading-message').textContent = "Please log in first";
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }
                
                const response = await fetch(`${API_URL}/api/users`, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const users = await response.json();
                console.log("Users retrieved:", users);
                
                if (users.length === 0) {
                    document.getElementById('loading-message').textContent = "No other users available. Please create another account to play against.";
                    return;
                }
                
                const select = document.getElementById('opponent_id');
                const currentUserId = localStorage.getItem('user_id');
                console.log("Current user ID:", currentUserId);
                
                // Count how many opponents we add
                let opponentCount = 0;
                
                users.forEach(user => {
                    // Don't include current user
                    if (user.id != currentUserId) {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        select.appendChild(option);
                        opponentCount++;
                    }
                });
                
                if (opponentCount > 0) {
                    // Hide loading message and show form
                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('newGameForm').style.display = 'block';
                } else {
                    document.getElementById('loading-message').textContent = 
                        "No opponents available. Please create another account to play against.";
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('loading-message').textContent = 
                    "Error loading opponents. Please try again later.";
            }
        });
    </script>
</body>
</html>